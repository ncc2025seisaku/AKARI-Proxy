# AKARI Proxy の気になる点（やさしい言葉で）

## いま気になるところ（ざっくり一覧）
- UDPなので「届かない・順番ズレる・欠ける」が平気で起きる。欠けを拾う仕組みはあるが、遅い回線や高遅延だと不達/タイムアウトになりやすい。
- PSKさえ合えば誰でも使える。利用者の認証やレート制限がないため、第三者に見られたり使われたりするリスクがある。
- 暗号化(Eフラグ)は任意。`require_encryption=false` のままだと生データ+HMACで飛ぶので、ネットワーク上で中身を見られる。
- 返信を5秒だけキャッシュして再送に使うが、5秒を過ぎるとNACK/ACKが来ても再送できず、そのまま欠落扱いになる。
- HTTPレスポンスボディの上限が大きめ（既定で最大1GB）。悪意ある巨大レスポンスでメモリを食いつぶされるリスクがある。
- Web側でCSPなどのセキュリティヘッダを外す/書き換えるため、表示はしやすいがセキュリティは弱くなる。
- リダイレクト書き換えやHTML/CSS/JSの書き換えが壊れやすい場合がある（特殊なタグや圧縮されたままのデータなど）。

## 通信（UDP周り）
- UDPなのでパケットが落ちたり順番が入れ替わるのは普通に起きる。NACK/ACKで補正するが、ラウンド上限に達すると諦める。
- MTUを意識して1150B以下に抑えているが、実ネットワークのMTUがそれより小さいと断片化→ロスが増える。
- ソケット受信バッファを大きくしようとするが、OS設定によっては効かずドロップする可能性がある。
- タイムアウト後のリトライ回数は限られるので、慢性的に遅い回線では「未完のまま諦める」ケースがある。

## 暗号・鍵
- PSK長さや管理方法に強制力がない。弱いPSKでも通ってしまう。
- `require_encryption` を true にしないと暗号化が必須にならない。暗号化なしでは内容が丸見え。
- メッセージの`timestamp`は検証に使っておらず、古いパケットやリプレイを止める仕組みがない。

## Web Proxy（ブラウザ側）
- サービスワーカーやHTML/JS書き換えはシンプルな置換に頼っており、凝ったページでリンク書き換え漏れや壊れが起きうる。
- CSP/Locationなどを外したり書き換えるため、元サイトの安全策が効かなくなる場合がある。
- フィルタ機能は拡張子とContent-Type頼りで、データURLや複雑なMIME指定までは見切れない。

## リモートプロキシ（HTTP取得）
- HTTP取得は同期/非同期ともにリトライがない。上流が一瞬落ちただけで即エラーを返す。
- リダイレクト回数や特定ヘッダの制限が緩めなので、予期しない大きなレスポンスや長時間処理に巻き込まれる可能性がある。
- 上流のHTTPS証明書検証について特別な設定がなく、社内プロキシ環境や自己署名環境では失敗しやすい。

## 設定・運用
- PSKの読み込みをファイルや環境変数にできるが、権限管理を誤ると漏洩する。
- ログにメッセージIDやURLが出るため、平文で残したくない環境ではマスクが必要。
- Web Proxyは認証なしで誰でも叩けるので、公開ネットワークにそのまま置くと踏み台にされうる。

## テスト・検証ギャップ
- ここではテスト実行をしていないため、現状のユニットテスト/統合テストが通るか未確認。
- 負荷試験や長時間運転の安定性は未検証。特に大容量レスポンスや高レイテンシ環境での欠落再送挙動は実環境で確認が必要。
- 暗号化(Eフラグ)付きのエンドツーエンド疎通、NACK/ACKが多発する状況での復旧精度なども手動/自動テストを追加したい。
