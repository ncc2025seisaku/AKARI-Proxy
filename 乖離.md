# 乖離 (負荷テスト用デモ環境での調整メモ)

- 対象: `py/akari/udp_server.py`, `py/akari/remote_proxy/handler.py`, `loadtest/` 配下のスイート。実環境には未適用。

## デモサーバー側の強化ポイント
- **非同期デフォルト**: `--async-demo-server` を前提に、ローカルのデモ応答を並列処理。
- **Brotli 応答を強制**: v2 応答は常に Brotli 圧縮し、`content-encoding: br` を付与。
- **ヘッド冗長送信**: 先頭チャンクを複数回送信（環境変数 `AKARI_HEAD_DUP_COUNT`、大容量は最低 2 回）。
- **大容量閾値**: `AKARI_LARGE_BODY_THRESHOLD` (既定 512KB) 以上はヘッド冗長を自動で増やす。

## 負荷テスト用ハンドラ側の強化ポイント
- **冗長チャンク送信**: `AKARI_RESP_DUP_COUNT` / `AKARI_HEAD_DUP_COUNT` で全チャンク／先頭チャンクの重複送信数を指定可能。
- **軽量FEC (XOR パリティ)**: `AKARI_FEC_PARITY=1` またはボディが閾値超過時にパリティチャンクを付与して再構成率を向上。
- **Brotli 圧縮**: 受信ボディを解凍し、レスポンスでは Brotli 圧縮して返却。
- **NACK 暴走抑制**: クライアント側で NACK 送信間隔を 50ms 以上にし、上限ラウンド数を設定。
- **HTTP キャッシュ**: 軽量なローカルキャッシュで再取得を抑制（TTL はヘッダーに依存）。

## スイート構成の特徴
- 災害チェックリストに合わせたシナリオ（高遅延+高ロス、フラップ、MTU揺れ、巨大レスポンスなど）をプリセット。
- 各シナリオのタイムアウト／リトライ／NACK 上限を緩めに設定し、テストでの「最低限動く」状態を重視。
- デフォルトはローカルデモサーバーに向け、`--demo-server` を外すと実環境に向かうため、実行時のホスト指定に注意。

## 実環境との差異リスク
- 実環境では Brotli 強制・ヘッド複製・パリティ送信が無効のままかもしれないため、大容量や高ロス時の耐性が低下する可能性。
- デモ環境は非同期＆局所ネットワークで遅延が小さい。実環境のバックエンド遅延や帯域制限、PSK/認証設定は別途確認が必要。
- テスト用のゆるめタイムアウト／再送設定は実運用値と乖離している前提。実環境へ適用する場合は段階的に検証が必要。

## 実環境へ反映する際の優先案
1. Brotli 応答の強制とヘッド複製、パリティ付与の有効化（大容量向け耐性を先に担保）。
2. NACK 間隔・上限の導入で再送暴走を防止。
3. タイムアウト／リトライ／ハートビートの値を、実環境の遅延・ロス計測値に合わせて再チューニング。
